<image src="./images/fail2ban_banner.jpg" alt="fail2ban_banner">

# <p style="text-align: center">Установка и настройка fail2ban с использованем Ansible (практическое задание)</p>

## 1. Постановка задачи.

>Напиши ansible playbook, который устанавливает и настраивает на сервере fail2ban. в условиях должны быть прописано увеличение времени блокировки злоумышленника с каждой новой неудачной попыткой подключиться по ssh к серверу. так же должна быть предусмотрена возможность перманентной блокировки ip адреса, после заданного в переменных количества неудачных попыток подключения.

## 2. Файловая структура проекта.

Общая файловая структура проекта выглядит следующим образом:

<image src="./images/project_structure.jpg" alt="project_structure">

## 3. Описание релизации задачи.

Задача была реализована с помощью Ansible версии 5.9.0-1 через создание роли deploy_fail2ban.

В качестве тестового оборудования были использованы 2 сервера с ОС Linux: 
- Ubuntu 22.04.4 LTS
- Fedora 39

Для настройки fail2ban на удалённых машинах был написан шаблон `jail.j2`, который, после установки программы, загружается как `jail.local` в директорию `/etc/fail2ban/`.

Для решения задачи блокировки по заданию, были применены следующие настройки в `jail.local`:

```yml
[DEFAULT]
bantime  = 10s
findtime = 30s
maxretry = 1

ignoreip = 127.0.0.1

# Advanced parameters
bantime.increment = true

[sshd]
enabled = true

[recidive]
enabled = true
bantime = -1
findtime = 1d
maxretry = {{ max_bans }}
```

Задачу увеличения времени блокировки злоумышленника с каждой новой неудачной попыткой подключиться по ssh к серверу решают параметры:

```yml
[DEFAULT]
bantime  = 10s
findtime = 30s
maxretry = 1

ignoreip = 127.0.0.1

# Advanced parameters
bantime.increment = true
```

В результате этих настроек, ip злоумышленника будет блокироваться каждый раз при неудачной попытке подключиться (`maxretry = 1`) на 10 секунд с увеличением времени после каждой неудачной попыткой (`bantime.increment = true`).

С помощью параметров в секции `[recidive]` решается задача перманентной блокировки ip злоумышленника навсегда:

```yml
[recidive]
enabled = true
bantime = -1
findtime = 1d
maxretry = {{ max_bans }}
```
Здесь за максимальное количество банов до окончательной блокировки отвечает параметр `maxretry = {{ max_bans }}`. При этом, переменная `max_bans` установлена в файле `/etc/ansible/roles/deploy_fail2ban/defaults/main.yml` и ограничена числом 15, но может быть переопределена в файле `hosts.yml` на другое необходимое значение.  
После того как ip злоумышленника набрал максимальное количество банов, срабатывает параметр `bantime = -1`, который означает окончательную блокировку и ip блокируется навсегда.